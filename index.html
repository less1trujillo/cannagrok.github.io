<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>CANNAGROK | AI-Powered Legal Cannabis Map</title>
    <meta name="description" content="National map of 1,000+ legal dispensaries (THC, THCA, CBD). Powered by AI. 21+ only.">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --green-dark: #1B5E20;
            --green-light: #66BB6A;
            --gray-dark: #212121;
            --white: #FFFFFF;
            --gold-accent: #FFD700; 
            --dark-overlay: rgba(0, 0, 0, 0.75); 
            --bg-light: #f5f5f5; /* For dashboard background */
            --bg-card: #ffffff;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--bg-light); 
            color: var(--gray-dark); 
            line-height: 1.6;
        }
        header { 
            background: var(--green-dark); 
            padding: 20px; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            gap: 12px;
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
            text-decoration: none;
            font-weight: 900;
            font-size: 28px;
        }
        .logo svg { width: 40px; height: 40px; }
        .tagline { 
            color: #A5D6A7; 
            font-size: 14px; 
            font-weight: 400; 
            margin-top: 4px;
            text-align: center;
        }
        h1 { font-size: 36px; margin: 20px 0 8px; color: var(--green-dark); text-align: center; }
        .subtitle { font-size: 18px; color: #43A047; margin-bottom: 10px; text-align: center; }
        .legal { font-size: 12px; color: #666; margin-bottom: 15px; text-align: center; }
        .controls { 
            margin: 20px auto; 
            display: flex; 
            justify-content: center; 
            gap: 12px; 
            flex-wrap: wrap; 
            max-width: 1000px;
        }
        .controls select, .controls input { 
            padding: 14px; 
            border-radius: 12px; 
            border: 1px solid #DDD; 
            font-size: 16px; 
            min-width: 240px;
        }
        .controls select { background: white; }
        .state-info { 
            font-size: 16px; 
            color: var(--green-dark); 
            margin: 10px; 
            font-weight: 600; 
            text-align: center;
        }
        .popup-link { color: var(--green-light); font-weight: 700; text-decoration: none; }
        
        /* ---------------------------------------------------- */
        /* === NEW APP STRUCTURE (MAP + DASHBOARD) === */
        /* ---------------------------------------------------- */
        #app-container {
            display: flex;
            max-width: 1400px;
            margin: 20px auto;
            gap: 20px;
            padding: 0 20px;
            min-height: 600px; 
        }

        #map-area {
            flex-grow: 1; /* Map takes remaining space */
            min-width: 60%;
            position: relative;
        }
        
        #map-container {
            height: 600px;
            position: relative;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        #map { 
            height: 100%; 
            width: 100%; 
        }

        /* PREMIUM DASHBOARD */
        #premiumDashboard {
            width: 350px;
            background: var(--white);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            flex-shrink: 0; /* Prevents shrinking */
            display: none; /* Only visible if PREMIUM */
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
            border: 2px solid var(--green-light);
        }
        #premiumDashboard h2 {
            font-size: 24px;
            color: var(--green-dark);
            margin-bottom: 10px;
            text-align: center;
        }
        .dashboard-section {
            padding: 15px;
            border-radius: 10px;
            background: var(--bg-light);
            border: 1px solid #E0E0E0;
        }
        /* ... (Keep other dashboard styles as before) ... */
        .profile-form select, .profile-form input[type="text"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 8px;
            border: 1px solid #ccc;
            background: var(--white);
        }
        .profile-form label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9em;
            font-weight: 600;
            color: var(--green-dark);
        }
        .profile-form button {
            background: var(--green-dark);
            color: white;
            padding: 10px;
            border: none;
            border-radius: 8px;
            width: 100%;
            font-weight: 700;
        }
        
        /* ---------------------------------------------------- */
        /* === AGE VERIFICATION / LOGIN MODAL STYLES (NEW) === */
        /* ---------------------------------------------------- */

        #ageGateOverlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--dark-overlay); 
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000; 
            /* Start visible, JS will hide it */
        }

        #loginModal {
            background: var(--white);
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
            max-width: 400px;
            width: 90%;
            text-align: center;
            border: 3px solid var(--green-dark);
        }

        #loginModal h2 {
            color: var(--green-dark);
            font-size: 28px;
            margin-bottom: 10px;
        }

        #loginModal p {
            margin-bottom: 20px;
            color: #666;
        }

        .login-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 16px;
        }

        .login-button {
            width: 100%;
            padding: 15px;
            background: var(--green-light);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: background 0.2s;
        }
        .login-button:hover { background: var(--green-dark); }
        
        /* ---------------------------------------------------- */
        /* === PREMIUM LOCKING STYLES (MODIFIED) === */
        /* ---------------------------------------------------- */
        
        /* We remove the .premium-locked blur from the map entirely */
        /* We use the paywall ONLY to promote the AI Dashboard */
        
        #map.ai-locked {
            filter: blur(5px);
            pointer-events: none;
            user-select: none;
            opacity: 0.6;
        }
        
        #paywall-overlay {
            /* Keep all original paywall styles but make it less aggressive */
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            /* Make overlay slightly transparent white so map is visible but AI feature is promoted */
            background-color: rgba(255, 255, 255, 0.85); 
            text-align: center;
            padding: 20px;
            z-index: 100; 
            border-radius: 16px;
            display: none; /* Only show if map is unlocked but AI is locked */
        }
        
        #paywall-overlay h2 {
            color: var(--gold-accent);
            font-size: 2.0em; /* Smaller */
            margin-bottom: 10px;
            color: var(--green-dark);
            text-shadow: none;
        }
        #paywall-overlay p {
            color: var(--gray-dark);
            font-size: 1.2em;
            max-width: 80%;
            margin-bottom: 20px;
        }
        .cta-button-large {
            /* Keep original styles */
            background: var(--gold-accent);
            color: var(--gray-dark);
            padding: 15px 30px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 900;
            font-size: 1.1em;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .unpaid-link {
            color: var(--green-dark); /* Changed color */
            text-decoration: underline;
            margin-top: 10px;
            cursor: pointer;
        }


        @media (max-width: 1000px) {
            #app-container {
                flex-direction: column;
                min-height: auto;
            }
            #premiumDashboard {
                width: 100%;
            }
            #map-area {
                min-width: 100%;
            }
            #paywall-overlay {
                /* Make it look like a floating box on small screens */
                position: static;
                margin-top: 20px;
                background-color: var(--bg-card);
                border: 2px solid var(--gold-accent);
            }
        }
        
    </style>
</head>
<body>

    <div id="ageGateOverlay">
        <div id="loginModal">
            <h2>Welcome to CANNAGROK</h2>
            <p>Please log in and verify your age (21+) to unlock the national map of affiliates.</p>
            <input type="email" id="loginEmail" class="login-input" placeholder="Enter your Email">
            <input type="number" id="loginAge" class="login-input" placeholder="Enter your Age (21+)">
            <button class="login-button" onclick="loginAndVerify()">Unlock Map Access</button>
            <p style="font-size: 0.8em; margin-top: 15px; color: red;">You must be 21 or older to proceed.</p>
        </div>
    </div>
    <header>
        <a href="/" class="logo">
            <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <circle cx="50" cy="50" r="45" fill="none" stroke="currentColor" stroke-width="8"/>
                <path d="M50 20 L60 40 L75 45 L62 58 L65 75 L50 65 L35 75 L38 58 L25 45 L40 40 Z" fill="currentColor"/>
                <circle cx="50" cy="50" r="15" fill="currentColor"/>
            </svg>
            CANNAGROK
        </a>
    </header>

    <div class="tagline">Your AI-Powered Legal Cannabis Map</div>

    <h1>1,000+ Dispensaries Nationwide</h1>
    <p class="subtitle">Charlotte + All 50 States ‚Ä¢ THC, THCA, CBD</p>
    <p class="legal">21+. Farm Bill 2018 Compliant | Affiliates: 10-15% Commission</p>

    <div class="controls">
        <select id="stateSelect" onchange="centerOnState()">
            <option value="">Select State to Zoom</option>
            <option value="NC">North Carolina (THCA/CBD)</option>
            <option value="CA">California (THC Legal)</option>
            <option value="CO">Colorado (THC Legal)</option>
            <option value="NY">New York (THC Legal)</option>
            <option value="FL">Florida (Medical THC)</option>
            <option value="TX">Texas (THCA/CBD)</option>
            <option value="IL">Illinois (THC Legal)</option>
            <option value="MI">Michigan (THC Legal)</option>
            <option value="WA">Washington (THC Legal)</option>
            <option value="OR">Oregon (THC Legal)</option>
            <option value="NV">Nevada (THC Legal)</option>
            <option value="AZ">Arizona (THC Legal)</option>
            <option value="MA">Massachusetts (THC Legal)</option>
            <option value="NJ">New Jersey (THC Legal)</option>
            <option value="PA">Pennsylvania (Medical THC)</option>
        </select>
        <input type="text" id="search" placeholder="Search by name, product, or city..." onkeyup="filterMap()">
    </div>

    <div class="state-info" id="stateInfo">National View</div>

    <div id="app-container">
        
        <div id="map-area">
            <div id="map-container">
                
                <div id="paywall-overlay" style="display:none;">
                    <h2>ü§ñ UNLOCK THE CANNABIS AI ASSISTANT</h2>
                    <p>Go Premium to unlock the **AI Auto-Assistant**. Get **personalized product recommendations**, local offers, and instant answers to your cannabis queries (legality, strains, usage) based on your profile.</p>
                    <a href="https://paypal.me/cannagrok/4.99" target="_blank" class="cta-button-large">
                        ACTIVATE AI ASSISTANT ($4.99/mo)
                    </a>
                    <div class="premium-message">
                        Already paid? <a href="#" class="unpaid-link" onclick="unlockPremium()">Enter your unlock code here</a>
                    </div>
                    
                    <a href="https://twitter.com/intent/tweet?text=The%20CANNAGROK%20map%20is%20now%20AI-powered!%20$4.99%20gets%20you%20a%20personal%20Auto-Assistant.%20%F0%9F%A7%A0%20%5BYour%20URL%5D%20%23CANNAGROK%20%23AIAssistant" target="_blank" class="x-share-button" style="margin-top: 15px;">
                        <svg class="x-icon" viewBox="0 0 24 24" aria-hidden="true" fill="white"><g><path d="M18.244 2.25h3.308l-7.227 8.261 8.527 11.239H20.73l-7.794-9.846L19.24 22H15.75L12.33 16.5L6.096 22H3.725L10.741 12.871L3.056 2.25h3.308l5.215 6.817L18.244 2.25zm-2.883 18l1.83 2.146h-2.181L8.718 9.38L3.483 22H1.109l7.794-9.846L2.252 2.25h4.15l4.631 6.035L14.773 2.25h4.218l-7.447 9.873z"></path></g></svg>
                        Share the AI Upgrade on X!
                    </a>
                </div>
                
                <div id="map" class="ai-locked"></div>
            </div>
        </div>

        <div id="premiumDashboard">
            <h2>CANNAGROK AI Dashboard</h2>
            
            <div id="aiChatModule" class="dashboard-section">
                <h3>Ask Grok - AI Auto-Assistant</h3>
                <div id="chatPlaceholder">
                    <p style="color:#1B5E20; font-weight:700;">Grok: I am ready! Based on your profile, how can I help you today?</p>
                    <p>Try: "What are the best Indica strains for sleep near me?"</p>
                </div>
                <input type="text" id="chatInput" placeholder="Your query (e.g., 'legal status in Texas?')...">
                <button id="grokButton" onclick="askGrok()">Ask Grok</button>
                <div id="queryCounter">15/15 Daily Queries Remaining</div>
            </div>

            <div class="dashboard-section">
                <h3>Your AI Profile (Personalization)</h3>
                <form class="profile-form">
                    <label for="profileGoal">Primary Goal:</label>
                    <select id="profileGoal">
                        <option value="sleep">Sleep/Insomnia</option>
                        <option value="pain">Pain Relief</option>
                        <option value="anxiety">Stress/Anxiety</option>
                        <option value="energy">Energy/Focus</option>
                        <option value="creative">Creativity</option>
                    </select>

                    <label for="profileExperience">Experience Level:</label>
                    <select id="profileExperience">
                        <option value="novice">Novice (First time)</option>
                        <option value="casual">Casual (Occasional use)</option>
                        <option value="intermediate">Intermediate (Daily/Weekly)</option>
                        <option value="expert">Expert (High tolerance)</option>
                    </select>
                    
                    <label for="profileZip">Base Zip Code (Local Offers):</label>
                    <input type="text" id="profileZip" placeholder="e.g., 28205">
                    
                    <button type="button" onclick="saveProfile()">Save Profile</button>
                </form>
            </div>
            
            <div class="dashboard-section">
                <h3>Your AI Recommendations</h3>
                <p style="font-size:0.9em; color:#444;">*The AI will list your top 5 personalized strain and product suggestions here, based on your profile and local store data.*</p>
                <ul style="margin-top:10px; list-style:none; padding-left:0;">
                    <li>- [Suggestion 1]</li>
                    <li>- [Suggestion 2]</li>
                </ul>
            </div>
            
            <div class="dashboard-section">
                <h3>Local VIP Deals</h3>
                <p style="font-size:0.9em; color:#444;">*Daily alerts on the best local discounts and offers from affiliates near your Zip Code (e.g., 20% off Edibles).*</p>
            </div>
        </div>
        
    </div>
    <div class="insights-section">
        <h2>CANNAGROK Insights (Free Education)</h2>
        <div class="insights-grid">
            
            <div class="insight-card">
                <h3><span class="insight-icon">üåø</span> Legalization 101: Farm Bill THCA</h3>
                <p>Learn the legal distinction between THC and THCA. Discover why hundreds of dispensaries across non-legal states (like North Carolina and Texas) can sell high-potency products under the 2018 Farm Bill.</p>
                <a href="#" class="cta-mini">Read the full Free Guide ‚Üí</a>
            </div>

            <div class="insight-card">
                <h3><span class="insight-icon">‚öñÔ∏è</span> Know Your State's Limits</h3>
                <p>A quick breakdown of recreational vs. medical vs. hemp laws. Always check your state's current possession limits for flowers, edibles, and concentrates before traveling.</p>
                <a href="#" class="cta-mini">View State by State Summary ‚Üí</a>
            </div>

            <div class="insight-card">
                <h3><span class="insight-icon">üî¨</span> Understanding Terpenes and Strains</h3>
                <p>What makes a Sativa different from an Indica? It‚Äôs the Terpenes! Learn how Myrcene, Limonene, and Pinene influence the effects of your favorite strains.</p>
                <a href="#" class="cta-mini">Explore the Terpene Database ‚Üí</a>
            </div>
            
        </div>
        
        <div class="premium-box" style="margin-top: 30px; background: #E8F5E9;">
            <p style="font-size:16px;">Want a personal guide? Unlock the **AI Auto-Assistant** for instant answers and personalized strain recommendations based on your unique goals.</p>
            <a href="https://paypal.me/cannagrok/4.99" target="_blank">Upgrade to AI Access ($4.99/mo)</a>
        </div>
    </div>
    <div class="premium-box">
        <div>PREMIUM $4.99/mo: AI AUTO-ASSISTANT</div>
        <div style="font-size:14px; margin:8px 0;">Personalized Product Guides ‚Ä¢ Local Offers ‚Ä¢ Instant Cannabis Answers</div>
        <a href="https://paypal.me/cannagrok/4.99" target="_blank">Upgrade to AI Access</a>
    </div>

    <footer>
        <p>¬© 2025 CANNAGROK | Powered by Grok & xAI | Charlotte, NC</p>
    </footer>

    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><circle cx=%2250%22 cy=%2250%22 r=%2245%22 fill=%22%231B5E20%22/><path d=%22M50 20 L60 40 L75 45 L62 58 L65 75 L50 65 L35 75 L38 58 L25 45 L40 40 Z%22 fill=%22white%22/><circle cx=%2250%22 cy=%2250%22 r=%2215%22 fill=%22white%22/></svg>" type="image/svg+xml">

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ------------------------------------------------------------------
        // === 0. MONETIZATION AND UNLOCK VARIABLES ===
        // ------------------------------------------------------------------
        const PREMIUM_SALES_LINK = "https://paypal.me/cannagrok/4.99"; // YOUR REAL URL
        const PREMIUM_UNLOCK_CODE = "CANNAGROK2025"; // STATIC CODE FOR PREMIUM USER
        const CANNAGROK_URL = window.location.href; 
        const MAX_DAILY_QUERIES = 15; // API COST CONTROL

        let queriesToday = parseInt(localStorage.getItem('grokQueriesToday')) || 0;
        let lastQueryDate = localStorage.getItem('lastQueryDate') || '';
        let currentZipLat, currentZipLng; 

        // ------------------------------------------------------------------
        // === I. ACCESS & FREEMIUM / PREMIUM LOGIC (MODIFIED) ===
        // ------------------------------------------------------------------
        
        function loginAndVerify() {
            const email = document.getElementById('loginEmail').value.trim();
            const age = parseInt(document.getElementById('loginAge').value.trim());

            if (!email || !age) {
                alert("Please enter both email and age.");
                return;
            }

            if (age < 21) {
                alert("Access Denied. You must be 21 or older to view this content.");
                return;
            }
            
            // SIMULATED LOGIN SUCCESS:
            localStorage.setItem('cannagrok_map_unlocked', 'true');
            localStorage.setItem('userEmail', email); // Save for future use
            
            document.getElementById('ageGateOverlay').style.display = 'none';
            document.getElementById('map').classList.remove('ai-locked'); // Unlock map view
            document.getElementById('paywall-overlay').style.display = 'flex'; // Show AI paywall overlay
            
            // Re-initialize map with full access
            loadProfileData(); 
        }

        function unlockPremium() {
            const code = prompt("Enter your CANNAGROK Premium Unlock Code:");
            
            if (code === PREMIUM_UNLOCK_CODE) {
                // 1. UNLOCK AI
                document.getElementById('map').classList.remove('ai-locked');
                document.getElementById('paywall-overlay').style.display = 'none';
                
                // 2. SHOW DASHBOARD
                document.getElementById('premiumDashboard').style.display = 'flex';
                
                // 3. SAVE STATE
                localStorage.setItem('cannagrok_premium', 'unlocked'); 
                localStorage.setItem('cannagrok_map_unlocked', 'true'); // Ensure map stays unlocked
                
                checkDailyReset();
                updateQueryCounter();
                loadProfileData(); 
                
                const tweetText = encodeURIComponent(`I just unlocked the CANNAGROK AI Auto-Assistant! For $4.99/mo, I get personalized strain guidance and local deals. This changes everything. ü§ñ‚û°Ô∏è ${CANNAGROK_URL} #CANNAGROK #AIAssistant #CannabisTech`);
                const tweetUrl = `https://twitter.com/intent/tweet?text=${tweetText}`;

                if (confirm("Premium AI Access Unlocked! Thank you for your subscription.\n\nHelp us grow: Would you like to share your successful AI upgrade on X/Twitter now?")) {
                    window.open(tweetUrl, '_blank');
                }
                
            } else if (code !== null) {
                alert("Incorrect code. Please verify your payment or click the 'Activate AI Access' button to subscribe.");
            }
        }
        
        function checkAccess() {
            const isMapUnlocked = localStorage.getItem('cannagrok_map_unlocked') === 'true';
            const isPremium = localStorage.getItem('cannagrok_premium') === 'unlocked';
            
            if (isPremium) {
                // PREMIUM: Map fully visible, AI Dashboard visible, no paywall overlay
                document.getElementById('ageGateOverlay').style.display = 'none';
                document.getElementById('map').classList.remove('ai-locked');
                document.getElementById('paywall-overlay').style.display = 'none';
                document.getElementById('premiumDashboard').style.display = 'flex';
                
            } else if (isMapUnlocked) {
                // FREE MAP: Map fully visible, AI Dashboard hidden, show AI paywall overlay
                document.getElementById('ageGateOverlay').style.display = 'none';
                document.getElementById('map').classList.remove('ai-locked');
                document.getElementById('paywall-overlay').style.display = 'flex';
                document.getElementById('premiumDashboard').style.display = 'none';
                
            } else {
                // LOCKED: Show age gate
                document.getElementById('ageGateOverlay').style.display = 'flex';
                // Map starts blurred/locked by default by the 'ai-locked' class (visual cue only)
            }
        }

        // --- Keep existing functions (updateQueryCounter, checkDailyReset, askGrok, saveProfile) ---
        function updateQueryCounter() {
            const remaining = MAX_DAILY_QUERIES - queriesToday;
            const counterElement = document.getElementById('queryCounter');
            const buttonElement = document.getElementById('grokButton');
            const inputElement = document.getElementById('chatInput');

            if (counterElement) {
                counterElement.textContent = `${remaining}/${MAX_DAILY_QUERIES} Daily Queries Remaining`;
            }
            if (buttonElement) {
                buttonElement.disabled = remaining <= 0;
            }
            if (inputElement) {
                inputElement.disabled = remaining <= 0;
            }
            if (remaining <= 0 && counterElement) {
                counterElement.textContent = `0/${MAX_DAILY_QUERIES} Daily Queries Remaining. Limit reached.`;
            }
        }

        function checkDailyReset() {
            const today = new Date().toDateString();
            if (today !== lastQueryDate) {
                queriesToday = 0;
                localStorage.setItem('grokQueriesToday', queriesToday);
                localStorage.setItem('lastQueryDate', today);
            }
        }

        function askGrok() {
            const input = document.getElementById('chatInput');
            const chatBox = document.getElementById('chatPlaceholder');
            const query = input.value.trim();

            if (!query) return;

            if (queriesToday >= MAX_DAILY_QUERIES) {
                chatBox.innerHTML += `<p style="color:red;">Limit reached. Please try again tomorrow.</p>`;
                input.value = '';
                chatBox.scrollTop = chatBox.scrollHeight;
                return;
            }

            // SIMULATE AI QUERY (In a real app, this would be the API call)
            queriesToday++;
            localStorage.setItem('grokQueriesToday', queriesToday);
            localStorage.setItem('lastQueryDate', new Date().toDateString());
            updateQueryCounter();
            
            const aiResponse = `Grok: Based on your query "${query}", I found 3 products that match your profile (Goal: ${localStorage.getItem('profileGoal') || 'N/A'}, Zip: ${localStorage.getItem('profileZip') || 'N/A'}). I've added them to your 'AI Recommendations' list on the dashboard. **The map markers are now prioritized by your Zip Code!**`;

            // Display conversation
            chatBox.innerHTML += `<p style="color:#212121; font-weight:600; margin-top:5px;">You: ${query}</p>`;
            chatBox.innerHTML += `<p style="color:#1B5E20; margin-bottom:5px;">${aiResponse}</p>`;
            
            input.value = '';
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function saveProfile() {
            const goal = document.getElementById('profileGoal').value;
            const exp = document.getElementById('profileExperience').value;
            const zip = document.getElementById('profileZip').value;

            localStorage.setItem('profileGoal', goal);
            localStorage.setItem('profileExperience', exp);
            localStorage.setItem('profileZip', zip);
            
            alert(`AI Profile Saved!\nGoal: ${goal}\nExperience: ${exp}\nZip: ${zip}\n\nUpdating map to prioritize local affiliates...`);
            loadProfileData(); // REFRESH MAP WITH NEW ZIP
        }
        // ------------------------------------------------------------------
        // === II. MAP CODE & ZIP CODE LOGIC (UNCHANGED from last revision) ===
        // ------------------------------------------------------------------
        
        const map = L.map('map').setView([39.8283, -98.5795], 4);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        let markers = L.layerGroup().addTo(map); 

        const stateCenters = {
            NC: [35.7596, -79.0193], CA: [36.7783, -119.4179], CO: [39.5501, -105.7821],
            NY: [40.7128, -74.0060], FL: [27.6648, -81.5158], TX: [31.9686, -99.9018],
            IL: [40.6331, -89.3985], MI: [44.3148, -85.6024], WA: [47.7511, -120.7401],
            OR: [43.8041, -120.5542], NV: [38.8026, -116.4194], AZ: [34.0489, -111.0937],
            MA: [42.4072, -71.3824], NJ: [40.0583, -74.4057], PA: [41.2033, -77.1945]
        };

        const shops = [
            // CHARLOTTE, NC (30+ THCA/CBD) - Keep these Affiliate links
            { name: "Hemp Hop", lat: 35.2271, lng: -80.8431, state: "NC", type: "THCA", link: "https://hemphop.co/?aff=cannagrok", note: "Delivery, 99% THCA diamonds" },
            { name: "Crowntown Cannabis", lat: 35.2235, lng: -80.8480, state: "NC", type: "THCA", link: "https://cltcbd.com/?aff=cannagrok", note: "321 East Blvd" },
            { name: "CannaBuddy", lat: 35.1520, lng: -80.7350, state: "NC", type: "THCA", link: "https://cannabuddy.com/?aff=cannagrok", note: "Curbside" },
            { name: "Happy Camper Lounge", lat: 35.2450, lng: -80.8050, state: "NC", type: "THCA", link: "https://beahappycamper.com/?aff=cannagrok", note: "NoDa" },
            { name: "Apotheca Cannabis", lat: 35.2100, lng: -80.8600, state: "NC", type: "THCA", link: "https://www.apotheca.org/?aff=cannagrok", note: "Concentrates" },
            { name: "KANNA CBD", lat: 35.2000, lng: -80.8300, state: "NC", type: "CBD", link: "https://kannacbd.org/?aff=cannagrok", note: "Gummies" },
            { name: "Dogwood Dispensary", lat: 35.2400, lng: -80.8200, state: "NC", type: "THCA", link: "https://dogwooddispensary.com/?aff=cannagrok", note: "Delivery" },
            { name: "Gazz Godz", lat: 35.2290, lng: -80.8290, state: "NC", type: "THCA", link: "https://www.gazzgodz.com/?aff=cannagrok", note: "Boutique" },
            { name: "Green Life CLT", lat: 35.2100, lng: -80.8600, state: "NC", type: "THCA", link: "https://www.greenlifeclt.com/?aff=cannagrok", note: "Shipping" },
            { name: "Seed to Soul", lat: 35.2350, lng: -80.8250, state: "NC", type: "THCA", link: "https://www.seedtosouldispensary.com/?aff=cannagrok", note: "95% Carts" },
            { name: "Canna Call", lat: 35.2280, lng: -80.8420, state: "NC", type: "THCA", link: "https://cannacall.me/?aff=cannagrok", note: "1-Hour Delivery" },
            { name: "Stinky's Emporium", lat: 35.2200, lng: -80.8390, state: "NC", type: "THCA", link: "https://stinkysemporium.com/?aff=cannagrok", note: "Variety" },
            { name: "Higher Education", lat: 35.2320, lng: -80.8280, state: "NC", type: "THCA", link: "https://highereducationdispensary.com/?aff=cannagrok", note: "Indoor" },
            { name: "Get The Bud", lat: 35.2050, lng: -80.8550, state: "NC", type: "THCA", link: "https://getthebud.com/?aff=cannagrok", note: "No Minimum" },
            { name: "The Hemp Doctor", lat: 35.2380, lng: -80.8180, state: "NC", type: "THCA", link: "https://thehempdoctor.com/?aff=cannagrok", note: "Edibles" },
            { name: "Blue Flowers", lat: 35.2260, lng: -80.8440, state: "NC", type: "THCA", link: "https://blueflowersnc.com/?aff=cannagrok", note: "Premium" },
            { name: "Pure Roots", lat: 35.1000, lng: -80.7500, state: "NC", type: "THCA", link: "https://purerootsbotanicals.com/?aff=cannagrok", note: "Organic" },
            { name: "Carolinas Finest", lat: 35.0800, lng: -80.6700, state: "NC", type: "THCA", link: "https://carolinasfinestdispensary.com/?aff=cannagrok", note: "Gastonia" },
            { name: "Great Smoky Cannabis", lat: 35.4317, lng: -83.4497, state: "NC", type: "THCA", link: "https://www.greatsmokycannabisco.com/?aff=cannagrok", note: "Tribal" },
            { name: "Preston Hemp Co", lat: 35.2271, lng: -80.8431, state: "NC", type: "THCA", link: "https://prestonhempco.com/?aff=cannagrok", note: "Online Only" },
            // Sample THC Legal Affiliates (Non-Charlotte) - Keep these Affiliate links
            { name: "MedMen", lat: 34.0928, lng: -118.3587, state: "CA", type: "THC", link: "https://medmen.com/?aff=cannagrok", note: "Los Angeles" },
            { name: "Cookies", lat: 40.7128, lng: -74.0060, state: "NY", type: "THC", link: "https://cookies.co/?aff=cannagrok", note: "Manhattan" },
            { name: "Green Dot Labs", lat: 39.7392, lng: -104.9903, state: "CO", type: "THC", link: "https://greendotlabs.com/?aff=cannagrok", note: "Denver" },
            { name: "Sunnyside", lat: 28.5383, lng: -81.3792, state: "FL", type: "Medical THC", link: "https://sunnyside.shop/?aff=cannagrok", note: "Orlando" },
            { name: "Trulieve", lat: 30.3322, lng: -81.6557, state: "FL", type: "Medical THC", link: "https://www.trulieve.com/?aff=cannagrok", note: "Jacksonville" },
            // Other US locations (Non-Affiliate, for map density/filler)
            { name: "Denver Relief", lat: 39.7523, lng: -104.9965, state: "CO", type: "THC", link: "#", note: "Denver" },
            { name: "The Green Solution", lat: 39.7719, lng: -105.0061, state: "CO", type: "THC", link: "#", note: "Denver" },
            { name: "Harvest of Tempe", lat: 33.4255, lng: -111.9400, state: "AZ", type: "THC", link: "#", note: "Phoenix" },
            { name: "The Reef", lat: 47.6062, lng: -122.3321, state: "WA", type: "THC", link: "#", note: "Seattle" },
            { name: "Dispensary 33", lat: 41.9796, lng: -87.6690, state: "IL", type: "THC", link: "#", note: "Chicago" }
        ];

        function getZipCodeCoordinates(zip) {
            const zipCoords = {
                '28205': [35.2346, -80.8037], // Charlotte (NoDa/Plaza Midwood area)
                '28204': [35.2173, -80.8309], // Charlotte (Midtown)
                '28202': [35.2270, -80.8453], // Charlotte (Uptown)
                '78701': [30.2672, -97.7431], // Austin, TX
                '90210': [34.0736, -118.4004], // Beverly Hills, CA
                '10001': [40.7505, -73.9968], // NYC, NY
                '80202': [39.7392, -104.9903] // Denver, CO
            };
            return zipCoords[zip] || null; 
        }

        function addMarkers(shopList, userLat, userLng) {
            markers.clearLayers(); 

            const shopsWithDistance = shopList.map(shop => {
                let distance = Infinity; 

                if (userLat && userLng) {
                    const userPoint = L.latLng(userLat, userLng);
                    const shopPoint = L.latLng(shop.lat, shop.lng);
                    distance = userPoint.distanceTo(shopPoint); 
                }
                
                return { ...shop, distance: distance };
            });

            shopsWithDistance.sort((a, b) => {
                if (a.distance !== b.distance) {
                    return a.distance - b.distance; 
                }
                return a.name.localeCompare(b.name);
            });

            shopsWithDistance.forEach(shop => {
                const distanceInMiles = shop.distance !== Infinity ? (shop.distance / 1609.34).toFixed(1) + ' mi' : 'N/A';
                
                const isAffiliate = shop.link.includes("?aff=cannagrok"); 
                
                const icon = isAffiliate 
                    ? L.divIcon({
                        className: 'affiliate-marker',
                        html: `<div style="background-color:#FFD700; color:#1B5E20; padding:4px 8px; border-radius:5px; font-weight:700; border:2px solid #1B5E20; box-shadow: 0 0 5px #FFD700;">‚≠ê</div>`,
                        iconSize: [30, 30],
                        iconAnchor: [15, 15]
                      })
                    : L.divIcon({ 
                        className: 'regular-marker',
                        html: `<div style="background-color:#1B5E20; color:white; padding:4px 8px; border-radius:5px; font-weight:700;">${shop.type}</div>`,
                        iconSize: [50, 20],
                        iconAnchor: [25, 10]
                      });


                const marker = L.marker([shop.lat, shop.lng], { icon: icon });

                let popupContent = `
                    <div style="font-family: 'Inter', sans-serif;">
                        <h4 style="margin: 0 0 5px; color: ${isAffiliate ? '#FFD700' : '#1B5E20'};">${shop.name} ${isAffiliate ? '(Affiliate Deal!)' : ''}</h4>
                        <p style="margin: 0 0 5px; font-size: 0.9em;">
                            <strong>Type:</strong> ${shop.type}<br>
                            <strong>Note:</strong> ${shop.note}<br>
                            ${shop.distance !== Infinity ? `<strong>Distance:</strong> ${distanceInMiles}<br>` : ''}
                        </p>
                        ${shop.link && shop.link !== '#'
                            ? `<a href="${shop.link}" target="_blank" class="popup-link" style="
                                display: block; 
                                margin-top: 10px; 
                                padding: 8px 12px; 
                                text-align: center; 
                                background-color: ${isAffiliate ? '#FFD700' : '#66BB6A'}; 
                                color: ${isAffiliate ? '#1B5E20' : 'white'};
                                border-radius: 5px; 
                                text-decoration: none;
                                font-weight: 700;
                                border: ${isAffiliate ? '2px solid #1B5E20' : 'none'};
                            ">VIEW STORE / CLAIM DEAL ‚Üí</a>`
                            : `<p style="margin-top:10px; font-size:0.8em; color:gray;">Link unavailable.</p>`
                        }
                    </div>
                `;

                marker.bindPopup(popupContent);
                markers.addLayer(marker);
            });

            // Update Local VIP Deals on Dashboard (if premium)
            const premiumStatus = localStorage.getItem('cannagrok_premium');
            const localDealsDiv = document.querySelector('#premiumDashboard .dashboard-section:nth-child(4)');

            if (premiumStatus === 'unlocked' && localDealsDiv) {
                const nearestAffiliates = shopsWithDistance.filter(s => s.link.includes("?aff=cannagrok") && s.distance !== Infinity).slice(0, 3);
                
                if (nearestAffiliates.length > 0) {
                    let dealsHtml = `<p style="font-size:0.9em; color:#444;">*Daily alerts on the best local discounts and offers from affiliates near your Zip Code (${localStorage.getItem('profileZip')}).*</p>`;
                    nearestAffiliates.forEach(shop => {
                        const distMi = (shop.distance / 1609.34).toFixed(1);
                        dealsHtml += `<p style="margin: 5px 0;"><strong>üî• VIP Deal:</strong> ${shop.name} (${distMi} mi) - <a href="${shop.link}" target="_blank" style="color:var(--green-dark); font-weight:700;">View Offer</a></p>`;
                    });
                    localDealsDiv.innerHTML = `<h3>Local VIP Deals</h3>${dealsHtml}`;
                } else {
                     localDealsDiv.innerHTML = `<h3>Local VIP Deals</h3><p style="font-size:0.9em; color:#444;">No affiliates found near your Zip Code.</p>`;
                }
            }
        }

        function centerOnState() {
            const stateCode = document.getElementById('stateSelect').value;
            const infoDiv = document.getElementById('stateInfo');
            
            if (stateCode) {
                const [lat, lng] = stateCenters[stateCode];
                map.setView([lat, lng], 10);
                infoDiv.textContent = `Displaying: ${document.querySelector('#stateSelect option:checked').text}`;
                filterMap(); 
            } else {
                map.setView([39.8283, -98.5795], 4);
                infoDiv.textContent = 'National View';
                filterMap(); 
            }
        }

        function filterMap() {
            const searchTerm = document.getElementById('search').value.toLowerCase();
            const selectedState = document.getElementById('stateSelect').value;
            
            const filteredShops = shops.filter(shop => {
                const stateMatch = !selectedState || shop.state === selectedState;
                const searchMatch = !searchTerm || 
                                    shop.name.toLowerCase().includes(searchTerm) ||
                                    shop.type.toLowerCase().includes(searchTerm) ||
                                    shop.note.toLowerCase().includes(searchTerm);
                return stateMatch && searchMatch;
            });

            addMarkers(filteredShops, currentZipLat, currentZipLng); 
        }

        function loadProfileData() {
            document.getElementById('profileGoal').value = localStorage.getItem('profileGoal') || 'sleep';
            document.getElementById('profileExperience').value = localStorage.getItem('profileExperience') || 'novice';
            
            const userZip = localStorage.getItem('profileZip');
            document.getElementById('profileZip').value = userZip || '';
            
            const coords = getZipCodeCoordinates(userZip);

            if (coords) {
                currentZipLat = coords[0];
                currentZipLng = coords[1];
            } else {
                currentZipLat = 35.2271; 
                currentZipLng = -80.8431; 
            }

            filterMap();
        }

        window.onload = function() {
            checkDailyReset();
            updateQueryCounter();
            checkAccess(); // Determines initial state (Age Gate, Free Map, or Premium)
            loadProfileData(); 
        }
        
    </script>
</body>
</html>
