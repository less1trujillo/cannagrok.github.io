<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>CANNAGROK | AI-Powered Legal Cannabis Map</title>
    <meta name="description" content="National map of 1,000+ legal dispensaries (THC, THCA, CBD). Powered by AI. 21+ only.">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        /* ==================================================== */
        /* === 1. GLOBAL STYLES & VARIABLES (MODERN PALETTE) === */
        /* ==================================================== */
        :root {
            --green-dark: #008000; /* Verde m√°s vivo y corporativo */
            --green-light: #4CAF50; /* Verde claro de acento */
            --gray-dark: #333333;
            --white: #FFFFFF;
            --gold-accent: #FFC107; /* Dorado m√°s vibrante */
            --dark-overlay: rgba(0, 0, 0, 0.85); 
            --bg-light: #F7F7F7; /* Fondo general muy claro */
            --bg-card: #FFFFFF;
            --shadow-md: 0 4px 15px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 30px rgba(0, 0, 0, 0.15);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--bg-light); 
            color: var(--gray-dark); 
            line-height: 1.6;
            transition: background 0.3s;
        }

        /* === Header & Branding === */
        header { 
            background: var(--green-dark); 
            padding: 15px 20px; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
            text-decoration: none;
            font-weight: 900;
            font-size: 26px;
        }
        .logo svg { width: 30px; height: 30px; fill: white; }
        .tagline { 
            color: #C8E6C9; 
            font-size: 13px; 
            font-weight: 400; 
            text-align: center;
            padding: 5px 0 15px;
            background: var(--green-dark); 
        }
        h1 { font-size: 32px; margin: 20px 0 5px; color: var(--green-dark); text-align: center; font-weight: 900; }
        .subtitle { font-size: 16px; color: #666; margin-bottom: 15px; text-align: center; }
        .legal { font-size: 11px; color: #888; margin-bottom: 10px; text-align: center; }

        /* === Controls (Search & Filters) === */
        .controls { 
            margin: 15px auto; 
            display: flex; 
            justify-content: center; 
            gap: 12px; 
            flex-wrap: wrap; 
            max-width: 1200px;
            padding: 0 20px;
        }
        .controls select, .controls input { 
            padding: 12px 15px; 
            border-radius: 8px; 
            border: 1px solid #DDD; 
            font-size: 15px; 
            min-width: 200px;
            background: var(--white);
            transition: border-color 0.3s;
        }
        .controls select:focus, .controls input:focus {
            border-color: var(--green-light);
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2);
            outline: none;
        }
        .state-info { 
            font-size: 15px; 
            color: var(--green-dark); 
            margin: 10px 0; 
            font-weight: 600; 
            text-align: center;
        }

        /* ==================================================== */
        /* === 2. APP STRUCTURE (MAP + DASHBOARD) === */
        /* ==================================================== */
        #app-container {
            display: flex;
            max-width: 1400px;
            margin: 20px auto;
            gap: 20px;
            padding: 0 20px;
            min-height: 70vh; 
        }

        #map-area {
            flex-grow: 1; 
            min-width: 60%;
            position: relative;
        }
        
        #map-container {
            height: 650px; /* Mapa m√°s alto */
            position: relative;
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            border: 1px solid #E0E0E0;
        }
        
        #map { 
            height: 100%; 
            width: 100%; 
        }

        /* === Leaflet Custom Markers (Nuevos Iconos) === */
        .affiliate-marker div {
            background-color: var(--gold-accent);
            color: var(--green-dark);
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: 700;
            border: 2px solid var(--green-dark);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            font-size: 10px;
        }
        .regular-marker div {
            background-color: var(--green-dark);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: 700;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            font-size: 10px;
        }

        /* === Popup Styles === */
        .popup-link { 
            color: white; 
            font-weight: 700; 
            text-decoration: none;
            display: block; 
            padding: 8px 12px; 
            text-align: center; 
            background-color: var(--green-light); 
            border-radius: 5px; 
            transition: background-color 0.2s;
        }
        .popup-link:hover {
            background-color: var(--green-dark);
        }
        
        /* === PREMIUM DASHBOARD (Modern Card) === */
        #premiumDashboard {
            width: 350px;
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            box-shadow: var(--shadow-lg);
            flex-shrink: 0; 
            display: none; 
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
            border: 2px solid var(--gold-accent); /* Borde dorado Premium */
        }
        #premiumDashboard h2 {
            font-size: 22px;
            color: var(--green-dark);
            margin-bottom: 10px;
            text-align: center;
            font-weight: 900;
        }
        .dashboard-section {
            padding: 15px;
            border-radius: 12px;
            background: var(--bg-light);
            border: 1px solid #E0E0E0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .dashboard-section h3 {
            color: var(--green-dark);
            font-size: 16px;
            margin-bottom: 10px;
            font-weight: 700;
        }

        /* Chat Module */
        #chatPlaceholder {
            padding: 10px;
            background: #E8F5E9;
            border-radius: 8px;
            margin-bottom: 10px;
            max-height: 150px;
            overflow-y: auto;
            font-size: 0.9em;
        }
        #chatInput, .profile-form select, .profile-form input[type="text"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 8px;
            border: 1px solid #ccc;
            background: var(--white);
        }
        #grokButton, .profile-form button {
            background: var(--green-light);
            color: white;
            padding: 10px;
            border: none;
            border-radius: 8px;
            width: 100%;
            font-weight: 700;
            cursor: pointer;
            transition: background 0.2s;
        }
        #grokButton:hover, .profile-form button:hover { background: var(--green-dark); }
        
        #queryCounter {
            text-align: right;
            font-size: 0.8em;
            color: #666;
            margin-top: 5px;
        }


        /* ==================================================== */
        /* === 3. MODALS & PAYWALL (Fluid UI) === */
        /* ==================================================== */

        #ageGateOverlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--dark-overlay); 
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000; /* Alto Z-index para asegurar visibilidad */
            opacity: 1;
            transition: opacity 0.3s ease-in-out;
        }
        .modal-hidden { opacity: 0; pointer-events: none; } /* Clase para ocultar */

        #loginModal {
            background: var(--bg-card);
            padding: 30px;
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            max-width: 400px;
            width: 90%;
            text-align: center;
            border: 3px solid var(--green-dark);
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .login-button {
            background: var(--green-dark);
            color: white;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: background 0.2s;
        }
        .login-button:hover { background: var(--green-light); }
        
        /* === AI PAYWALL PROMOTION === */
        #paywall-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex; /* Asegura que el contenido est√© centrado */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.95); /* Blanco semi-transparente */
            padding: 20px;
            z-index: 100; 
            border-radius: 16px;
            text-align: center;
        }
        #paywall-overlay h2 {
            font-size: 2.2em;
            color: var(--green-dark);
            margin-bottom: 10px;
            font-weight: 900;
        }
        #paywall-overlay p {
            color: var(--gray-dark);
            font-size: 1.1em;
            max-width: 80%;
            margin-bottom: 25px;
        }
        .cta-button-large {
            background: var(--gold-accent);
            color: var(--gray-dark);
            padding: 18px 40px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 900;
            font-size: 1.2em;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 10px rgba(255, 193, 7, 0.5);
        }
        .unpaid-link {
            color: var(--green-dark);
            text-decoration: underline;
            margin-top: 15px;
            cursor: pointer;
            font-size: 0.9em;
        }

        /* ==================================================== */
        /* === 4. RESPONSIVE DESIGN & FOOTER === */
        /* ==================================================== */
        @media (max-width: 1000px) {
            #app-container {
                flex-direction: column;
                min-height: auto;
            }
            #premiumDashboard {
                width: 100%;
            }
            #map-container {
                height: 400px;
            }
            .controls {
                flex-direction: column;
                gap: 10px;
            }
            .controls select, .controls input {
                min-width: 100%;
            }
            /* Make paywall float below map on mobile */
            #paywall-overlay {
                position: static;
                margin-top: 20px;
                background-color: var(--bg-card);
                border: 2px solid var(--gold-accent);
                box-shadow: var(--shadow-md);
            }
        }

        /* === Insights & Footer (Improved design) === */
        .insights-section {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 20px;
        }
        .insights-section h2 {
            font-size: 28px;
            color: var(--green-dark);
            margin-bottom: 20px;
            text-align: center;
        }
        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        .insight-card {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            border-left: 5px solid var(--green-light);
            transition: transform 0.2s;
        }
        .insight-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-lg); }
        .insight-card h3 { color: var(--gray-dark); font-size: 18px; margin-bottom: 10px; }
        .insight-icon { font-size: 1.2em; margin-right: 8px; color: var(--gold-accent); }
        .cta-mini { color: var(--green-dark); font-weight: 600; text-decoration: none; display: block; margin-top: 10px; }

        .premium-box {
            background: #FFFDE7; /* Fondo suave para promoci√≥n */
            border: 1px solid var(--gold-accent);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin: 30px auto;
            max-width: 800px;
            box-shadow: var(--shadow-md);
        }
        .premium-box a {
            background: var(--gold-accent);
            color: var(--gray-dark);
            padding: 10px 20px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 700;
            display: inline-block;
            margin-top: 10px;
            transition: background 0.2s;
        }
        .premium-box a:hover {
            background: #FFEB3B;
        }

        footer {
            text-align: center;
            padding: 20px;
            margin-top: 40px;
            font-size: 12px;
            color: #888;
            border-top: 1px solid #EEE;
        }
    </style>
</head>
<body>

    <div id="ageGateOverlay">
        <div id="loginModal">
            <h2>Welcome to CANNAGROK</h2>
            <p>Please log in and verify your age (21+) to unlock the national map of affiliates.</p>
            <input type="email" id="loginEmail" class="login-input" placeholder="Enter your Email" required>
            <input type="number" id="loginAge" class="login-input" placeholder="Enter your Age (21+)" required>
            <button class="login-button" onclick="loginAndVerify()">Unlock Map Access</button>
            <p style="font-size: 0.8em; margin-top: 15px; color: #999;">You must be 21 or older to proceed. The full map is free after verification.</p>
        </div>
    </div>
    <header>
        <a href="/" class="logo">
            <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <path d="M50 0C30 0 10 30 10 50S30 100 50 100 90 70 90 50 70 0 50 0zM50 20c-15 0-25 15-25 30s10 30 25 30 25-15 25-30-10-30-25-30z" fill="white"/>
                <circle cx="50" cy="50" r="10" fill="#008000"/>
            </svg>
            CANNAGROK
        </a>
    </header>

    <div class="tagline">Your AI-Powered Legal Cannabis Map</div>

    <h1>1,000+ Dispensaries Nationwide</h1>
    <p class="subtitle">Charlotte + All 50 States ‚Ä¢ THC, THCA, CBD</p>
    <p class="legal">21+. Farm Bill 2018 Compliant | Affiliates: 10-15% Commission</p>

    <div class="controls">
        <select id="stateSelect" onchange="centerOnState()">
            <option value="">Select State to Zoom</option>
            <option value="NC">North Carolina (THCA/CBD)</option>
            <option value="CA">California (THC Legal)</option>
            <option value="CO">Colorado (THC Legal)</option>
            <option value="NY">New York (THC Legal)</option>
            <option value="FL">Florida (Medical THC)</option>
            <option value="TX">Texas (THCA/CBD)</option>
            <option value="IL">Illinois (THC Legal)</option>
            <option value="MI">Michigan (THC Legal)</option>
            <option value="WA">Washington (THC Legal)</option>
            <option value="OR">Oregon (THC Legal)</option>
            <option value="NV">Nevada (THC Legal)</option>
            <option value="AZ">Arizona (THC Legal)</option>
            <option value="MA">Massachusetts (THC Legal)</option>
            <option value="NJ">New Jersey (THC Legal)</option>
            <option value="PA">Pennsylvania (Medical THC)</option>
        </select>
        <input type="text" id="search" placeholder="Search by name, product, or city..." onkeyup="filterMap()">
    </div>

    <div class="state-info" id="stateInfo">National View</div>

    <div id="app-container">
        
        <div id="map-area">
            <div id="map-container">
                
                <div id="paywall-overlay" style="display:none;">
                    <h2>ü§ñ UNLOCK THE CANNABIS AI ASSISTANT</h2>
                    <p>Go Premium to unlock the **AI Auto-Assistant**. Get **personalized product recommendations**, local offers, and instant answers to your cannabis queries (legality, strains, usage) based on your profile.</p>
                    <a href="https://paypal.me/cannagrok/4.99" target="_blank" class="cta-button-large">
                        ACTIVATE AI ASSISTANT ($4.99/mo)
                    </a>
                    <div class="premium-message">
                        Already paid? <a href="#" class="unpaid-link" onclick="unlockPremium()">Enter your unlock code here</a>
                    </div>
                </div>
                
                <div id="map" class="ai-locked"></div>
            </div>
        </div>

        <div id="premiumDashboard">
            <h2>CANNAGROK AI Dashboard</h2>
            <div class="dashboard-section" style="border: 2px solid var(--green-dark);">
                <h3>üåø Grok Knowledge: Flower First</h3>
                <p style="font-size: 0.9em; color: var(--green-dark); font-weight: 600;">
                    Your AI is trained in the **full "Seed to Consumer" life cycle**. Ask Grok about: **Terpenes, THC/THCA potency based on Flower Stage, Optimal Curing, and Cultivation methods (Indoor/Outdoor).**
                </p>
            </div>
            
            <div id="aiChatModule" class="dashboard-section">
                <h3>Ask Grok - AI Auto-Assistant</h3>
                <div id="chatPlaceholder">
                    <p style="color:#008000; font-weight:700;">Grok: I am ready! Based on your profile, how can I help you today?</p>
                </div>
                <input type="text" id="chatInput" placeholder="Your query (e.g., 'terpenes for sleep?')...">
                <button id="grokButton" onclick="askGrok()">Ask Grok</button>
                <div id="queryCounter">15/15 Daily Queries Remaining</div>
            </div>

            <div class="dashboard-section">
                <h3>Your AI Profile (Personalization)</h3>
                <form class="profile-form">
                    <label for="profileGoal">Primary Goal:</label>
                    <select id="profileGoal">
                        <option value="sleep">Sleep/Insomnia</option>
                        <option value="pain">Pain Relief</option>
                        <option value="anxiety">Stress/Anxiety</option>
                        <option value="energy">Energy/Focus</option>
                        <option value="creative">Creativity</option>
                    </select>

                    <label for="profileExperience">Experience Level:</label>
                    <select id="profileExperience">
                        <option value="novice">Novice (First time)</option>
                        <option value="casual">Casual (Occasional use)</option>
                        <option value="intermediate">Intermediate (Daily/Weekly)</option>
                        <option value="expert">Expert (High tolerance)</option>
                    </select>
                    
                    <label for="profileZip">Base Zip Code (Local Offers):</label>
                    <input type="text" id="profileZip" placeholder="e.g., 28205">
                    
                    <button type="button" onclick="saveProfile()">Save Profile</button>
                </form>
            </div>
            
            <div class="dashboard-section">
                <h3>Local VIP Deals</h3>
                <p style="font-size:0.9em; color:#444;">*Daily alerts on the best local discounts and offers from affiliates near your Zip Code.*</p>
            </div>
        </div>
        
    </div>
    
    <div class="insights-section">
        <h2>CANNAGROK Insights (Free Education)</h2>
        <div class="insights-grid">
            
            <div class="insight-card">
                <h3><span class="insight-icon">üåø</span> Legalization 101: Farm Bill THCA</h3>
                <p>Learn the legal distinction between THC and THCA. Discover why hundreds of dispensaries can sell high-potency products under the 2018 Farm Bill.</p>
                <a href="#" class="cta-mini">Read the full Free Guide ‚Üí</a>
            </div>

            <div class="insight-card">
                <h3><span class="insight-icon">‚öñÔ∏è</span> Know Your State's Limits</h3>
                <p>A quick breakdown of recreational vs. medical vs. hemp laws. Always check your state's current possession limits for flowers, edibles, and concentrates.</p>
                <a href="#" class="cta-mini">View State by State Summary ‚Üí</a>
            </div>

            <div class="insight-card">
                <h3><span class="insight-icon">üî¨</span> Understanding Terpenes and Strains</h3>
                <p>What makes a Sativa different from an Indica? It‚Äôs the Terpenes! Learn how Myrcene, Limonene, and Pinene influence the effects of your favorite strains.</p>
                <a href="#" class="cta-mini">Explore the Terpene Database ‚Üí</a>
            </div>
            
        </div>
    </div>
    
    <div class="premium-box">
        <div>PREMIUM $4.99/mo: AI AUTO-ASSISTANT (GROK)</div>
        <div style="font-size:14px; margin:8px 0;">Personalized Product Guides ‚Ä¢ Flower-First Knowledge ‚Ä¢ Local Offers</div>
        <a href="https://paypal.me/cannagrok/4.99" target="_blank">Upgrade to AI Access</a>
    </div>

    <footer>
        <p>¬© 2025 CANNAGROK | Powered by Grok & xAI | Charlotte, NC</p>
    </footer>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ------------------------------------------------------------------
        // === I. VARIABLES & ACCESS LOGIC (KEY FUNCTIONS) ===
        // ------------------------------------------------------------------
        const PREMIUM_SALES_LINK = "https://paypal.me/cannagrok/4.99";
        const PREMIUM_UNLOCK_CODE = "CANNAGROK2025";
        const MAX_DAILY_QUERIES = 15;

        let queriesToday = parseInt(localStorage.getItem('grokQueriesToday')) || 0;
        let lastQueryDate = localStorage.getItem('lastQueryDate') || '';
        let currentZipLat, currentZipLng; 

        function loginAndVerify() {
            const email = document.getElementById('loginEmail').value.trim();
            const age = parseInt(document.getElementById('loginAge').value.trim());

            if (!email || !age) {
                alert("Please enter both email and age.");
                return;
            }

            if (age < 21) {
                alert("Access Denied. You must be 21 or older to view this content.");
                return;
            }
            
            // SIMULATED LOGIN SUCCESS: Map Access is FREE after this step.
            localStorage.setItem('cannagrok_map_unlocked', 'true');
            localStorage.setItem('userEmail', email); 
            
            // Hide modal with smooth transition
            const ageGate = document.getElementById('ageGateOverlay');
            ageGate.classList.add('modal-hidden');
            setTimeout(() => { ageGate.style.display = 'none'; }, 300);

            // Show AI Paywall overlay on the map (only for promotion)
            document.getElementById('paywall-overlay').style.display = 'flex';
            
            loadProfileData(); 
        }

        function unlockPremium() {
            const code = prompt("Enter your CANNAGROK Premium Unlock Code:");
            
            if (code === PREMIUM_UNLOCK_CODE) {
                // UNLOCK AI & HIDE PROMOTIONAL PAYWALL
                document.getElementById('paywall-overlay').style.display = 'none';
                
                // SHOW DASHBOARD
                document.getElementById('premiumDashboard').style.display = 'flex';
                
                // SAVE STATE
                localStorage.setItem('cannagrok_premium', 'unlocked'); 
                localStorage.setItem('cannagrok_map_unlocked', 'true'); 
                
                checkDailyReset();
                updateQueryCounter();
                loadProfileData(); 
                
                alert("Premium AI Access Unlocked! Thank you for your subscription.");
                
            } else if (code !== null) {
                alert("Incorrect code. Please verify your payment or click the 'Activate AI Access' button to subscribe.");
            }
        }
        
        function checkAccess() {
            const isMapUnlocked = localStorage.getItem('cannagrok_map_unlocked') === 'true';
            const isPremium = localStorage.getItem('cannagrok_premium') === 'unlocked';
            
            if (isPremium) {
                document.getElementById('ageGateOverlay').style.display = 'none';
                document.getElementById('paywall-overlay').style.display = 'none';
                document.getElementById('premiumDashboard').style.display = 'flex';
                
            } else if (isMapUnlocked) {
                document.getElementById('ageGateOverlay').style.display = 'none';
                document.getElementById('paywall-overlay').style.display = 'flex';
                document.getElementById('premiumDashboard').style.display = 'none';
                
            } else {
                // Default: Show age gate. Use CSS class for smooth show/hide.
                document.getElementById('ageGateOverlay').style.display = 'flex';
                document.getElementById('ageGateOverlay').classList.remove('modal-hidden');
            }
        }

        // --- AI CHAT LOGIC (FLOWER-FIRST) ---
        function updateQueryCounter() {
            const remaining = MAX_DAILY_QUERIES - queriesToday;
            const counterElement = document.getElementById('queryCounter');
            const buttonElement = document.getElementById('grokButton');
            const inputElement = document.getElementById('chatInput');

            if (counterElement) {
                counterElement.textContent = `${remaining}/${MAX_DAILY_QUERIES} Daily Queries Remaining`;
            }
            if (buttonElement) {
                buttonElement.disabled = remaining <= 0;
            }
            if (inputElement) {
                inputElement.disabled = remaining <= 0;
            }
            if (remaining <= 0 && counterElement) {
                counterElement.textContent = `0/${MAX_DAILY_QUERIES} Daily Queries Remaining. Limit reached.`;
            }
        }

        function checkDailyReset() {
            const today = new Date().toDateString();
            if (today !== lastQueryDate) {
                queriesToday = 0;
                localStorage.setItem('grokQueriesToday', queriesToday);
                localStorage.setItem('lastQueryDate', today);
            }
        }

        function askGrok() {
            const input = document.getElementById('chatInput');
            const chatBox = document.getElementById('chatPlaceholder');
            const query = input.value.trim().toLowerCase();
            const userGoal = localStorage.getItem('profileGoal') || 'desconocido';
            const userExp = localStorage.getItem('profileExperience') || 'novice';
            const userZip = localStorage.getItem('profileZip') || 'N/A';

            if (!query) return;

            if (queriesToday >= MAX_DAILY_QUERIES) {
                chatBox.innerHTML += `<p style="color:red; margin-top:10px;">Grok: L√≠mite diario de consultas (${MAX_DAILY_QUERIES}) alcanzado. Intenta de nuevo ma√±ana.</p>`;
                input.value = '';
                chatBox.scrollTop = chatBox.scrollHeight;
                return;
            }

            // SIMULACI√ìN DE RESPUESTA AI AVANZADA (FLOWER-FIRST)
            let aiResponse = "";

            if (query.includes("terpenos") || query.includes("aroma")) {
                aiResponse = `Grok: Excelente pregunta. Basado en tu perfil (**Meta: ${userGoal}**), necesitas cepas altas en ${userGoal === 'sleep' ? 'Myrcene y Linalool' : 'Limonene y Pinene'}. Estos terpenos se desarrollan durante la fase de **Floraci√≥n tard√≠a** del cultivo y son clave para el efecto. Estoy revisando la base de datos de los **${userZip}** afiliados cercanos... Te recomiendo: [CANNABUDDY] por su alto contenido de Myrcene verificado en su √∫ltima prueba.`;
            } else if (query.includes("thca") || query.includes("legal")) {
                aiResponse = `Grok: En **${userZip}**, la legalidad del THCA se basa en el porcentaje de Delta-9-THC post-decarboxilaci√≥n, un proceso que simula el consumo. El THCA es la forma √°cida dominante en la flor cruda reci√©n cortada (etapa de **Cosecha/Post-Floraci√≥n**). Los afiliados cercanos (ej. [Hemp Hop]) manejan certificados que validan su cumplimiento con el Farm Bill.`;
            } else if (query.includes("potencia") || query.includes("fuerte")) {
                aiResponse = `Grok: La potencia (THC/THCA) se maximiza con una nutrici√≥n √≥ptima en la fase **Vegetativa** y un manejo preciso de la luz durante la **Floraci√≥n**. Para un **Experto** como t√∫ (${userExp}), he marcado los afiliados ([Apotheca Cannabis]) que tienen inventario con un total de canabinoides >30%, producto de un ciclo de cultivo enfocado en maximizar los tricomas.`;
            } else if (query.includes("cultivo") || query.includes("indoor")) {
                aiResponse = `Grok: La distinci√≥n **Indoor vs. Outdoor** es crucial. Los cultivos Indoor ([Green Dot Labs]) ofrecen tricomas m√°s densos debido al control total de luz (simulando 12h/12h en **Floraci√≥n**). Los Outdoor suelen tener un perfil de terpenos m√°s amplio. He filtrado tu mapa para priorizar las tiendas con producto 'Indoor Premium' para tu b√∫squeda.`;
            } else {
                aiResponse = `Grok: Entendido. Para tu consulta sobre "${query}", mi an√°lisis Flower-First te sugiere que busques productos con un buen curado. El curado (post-**Cosecha**) es vital para mantener los terpenos y reducir el 'harshness'. Estoy buscando las 3 mejores opciones de 'Flower' curada cerca de **${userZip}**.`;
            }
            
            queriesToday++;
            localStorage.setItem('grokQueriesToday', queriesToday);
            localStorage.setItem('lastQueryDate', new Date().toDateString());
            updateQueryCounter();
            
            // Display conversation
            chatBox.innerHTML += `<p style="color:#212121; font-weight:600; margin-top:5px;">T√∫: ${query}</p>`;
            chatBox.innerHTML += `<p style="color:#008000; margin-bottom:5px;">${aiResponse}</p>`;
            
            input.value = '';
            chatBox.scrollTop = chatBox.scrollHeight;
            
            document.getElementById('stateInfo').textContent = `AI Map Filter: ${userGoal} + ${userExp} | Actualizando ofertas cerca de ${userZip}...`;
        }

        function saveProfile() {
            const goal = document.getElementById('profileGoal').value;
            const exp = document.getElementById('profileExperience').value;
            const zip = document.getElementById('profileZip').value;

            localStorage.setItem('profileGoal', goal);
            localStorage.setItem('profileExperience', exp);
            localStorage.setItem('profileZip', zip);
            
            alert(`AI Profile Saved!\nGoal: ${goal}\nExperience: ${exp}\nZip: ${zip}\n\nUpdating map to prioritize local affiliates...`);
            loadProfileData(); 
        }

        // ------------------------------------------------------------------
        // === II. MAP CODE & DATA (ICONOS MEJORADOS) ===
        // ------------------------------------------------------------------
        
        const map = L.map('map').setView([39.8283, -98.5795], 4);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        let markers = L.layerGroup().addTo(map); 

        const stateCenters = {
            NC: [35.7596, -79.0193], CA: [36.7783, -119.4179], CO: [39.5501, -105.7821],
            NY: [40.7128, -74.0060], FL: [27.6648, -81.5158], TX: [31.9686, -99.9018],
            IL: [40.6331, -89.3985], MI: [44.3148, -85.6024], WA: [47.7511, -120.7401],
            OR: [43.8041, -120.5542], NV: [38.8026, -116.4194], AZ: [34.0489, -111.0937],
            MA: [42.4072, -71.3824], NJ: [40.0583, -74.4057], PA: [41.2033, -77.1945]
        };

        const shops = [
            // CHARLOTTE, NC (30+ THCA/CBD) - Keep these Affiliate links
            { name: "Hemp Hop", lat: 35.2271, lng: -80.8431, state: "NC", type: "THCA", link: "https://hemphop.co/?aff=cannagrok", note: "Delivery, 99% THCA diamonds" },
            { name: "Crowntown Cannabis", lat: 35.2235, lng: -80.8480, state: "NC", type: "THCA", link: "https://cltcbd.com/?aff=cannagrok", note: "321 East Blvd" },
            { name: "CannaBuddy", lat: 35.1520, lng: -80.7350, state: "NC", type: "THCA", link: "https://cannabuddy.com/?aff=cannagrok", note: "Curbside" },
            { name: "Happy Camper Lounge", lat: 35.2450, lng: -80.8050, state: "NC", type: "THCA", link: "https://beahappycamper.com/?aff=cannagrok", note: "NoDa" },
            { name: "Apotheca Cannabis", lat: 35.2100, lng: -80.8600, state: "NC", type: "THCA", link: "https://www.apotheca.org/?aff=cannagrok", note: "Concentrates" },
            { name: "KANNA CBD", lat: 35.2000, lng: -80.8300, state: "NC", type: "CBD", link: "https://kannacbd.org/?aff=cannagrok", note: "Gummies" },
            { name: "Dogwood Dispensary", lat: 35.2400, lng: -80.8200, state: "NC", type: "THCA", link: "https://dogwooddispensary.com/?aff=cannagrok", note: "Delivery" },
            { name: "Gazz Godz", lat: 35.2290, lng: -80.8290, state: "NC", type: "THCA", link: "https://www.gazzgodz.com/?aff=cannagrok", note: "Boutique" },
            { name: "Green Life CLT", lat: 35.2100, lng: -80.8600, state: "NC", type: "THCA", link: "https://www.greenlifeclt.com/?aff=cannagrok", note: "Shipping" },
            { name: "Seed to Soul", lat: 35.2350, lng: -80.8250, state: "NC", type: "THCA", link: "https://www.seedtosouldispensary.com/?aff=cannagrok", note: "95% Carts" },
            { name: "Canna Call", lat: 35.2280, lng: -80.8420, state: "NC", type: "THCA", link: "https://cannacall.me/?aff=cannagrok", note: "1-Hour Delivery" },
            { name: "Stinky's Emporium", lat: 35.2200, lng: -80.8390, state: "NC", type: "THCA", link: "https://stinkysemporium.com/?aff=cannagrok", note: "Variety" },
            { name: "Higher Education", lat: 35.2320, lng: -80.8280, state: "NC", type: "THCA", link: "https://highereducationdispensary.com/?aff=cannagrok", note: "Indoor" },
            { name: "Get The Bud", lat: 35.2050, lng: -80.8550, state: "NC", type: "THCA", link: "https://getthebud.com/?aff=cannagrok", note: "No Minimum" },
            { name: "The Hemp Doctor", lat: 35.2380, lng: -80.8180, state: "NC", type: "THCA", link: "https://thehempdoctor.com/?aff=cannagrok", note: "Edibles" },
            { name: "Blue Flowers", lat: 35.2260, lng: -80.8440, state: "NC", type: "THCA", link: "https://blueflowersnc.com/?aff=cannagrok", note: "Premium" },
            { name: "Pure Roots", lat: 35.1000, lng: -80.7500, state: "NC", type: "THCA", link: "https://purerootsbotanicals.com/?aff=cannagrok", note: "Organic" },
            { name: "Carolinas Finest", lat: 35.0800, lng: -80.6700, state: "NC", type: "THCA", link: "https://carolinasfinestdispensary.com/?aff=cannagrok", note: "Gastonia" },
            { name: "Great Smoky Cannabis", lat: 35.4317, lng: -83.4497, state: "NC", type: "THCA", link: "https://www.greatsmokycannabisco.com/?aff=cannagrok", note: "Tribal" },
            { name: "Preston Hemp Co", lat: 35.2271, lng: -80.8431, state: "NC", type: "THCA", link: "https://prestonhempco.com/?aff=cannagrok", note: "Online Only" },
            // Sample THC Legal Affiliates 
            { name: "MedMen", lat: 34.0928, lng: -118.3587, state: "CA", type: "THC", link: "https://medmen.com/?aff=cannagrok", note: "Los Angeles" },
            { name: "Cookies", lat: 40.7128, lng: -74.0060, state: "NY", type: "THC", link: "https://cookies.co/?aff=cannagrok", note: "Manhattan" },
            { name: "Green Dot Labs", lat: 39.7392, lng: -104.9903, state: "CO", type: "THC", link: "https://greendotlabs.com/?aff=cannagrok", note: "Denver" },
            { name: "Sunnyside", lat: 28.5383, lng: -81.3792, state: "FL", type: "Medical THC", link: "https://sunnyside.shop/?aff=cannagrok", note: "Orlando" },
            { name: "Trulieve", lat: 30.3322, lng: -81.6557, state: "FL", type: "Medical THC", link: "https://www.trulieve.com/?aff=cannagrok", note: "Jacksonville" },
            // Other US locations (Non-Affiliate, for map density/filler)
            { name: "Denver Relief", lat: 39.7523, lng: -104.9965, state: "CO", type: "THC", link: "#", note: "Denver" },
            { name: "The Green Solution", lat: 39.7719, lng: -105.0061, state: "CO", type: "THC", link: "#", note: "Denver" },
            { name: "Harvest of Tempe", lat: 33.4255, lng: -111.9400, state: "AZ", type: "THC", link: "#", note: "Phoenix" },
            { name: "The Reef", lat: 47.6062, lng: -122.3321, state: "WA", type: "THC", link: "#", note: "Seattle" },
            { name: "Dispensary 33", lat: 41.9796, lng: -87.6690, state: "IL", type: "THC", link: "#", note: "Chicago" }
        ];

        function getZipCodeCoordinates(zip) {
            const zipCoords = {
                '28205': [35.2346, -80.8037], // Charlotte (NoDa/Plaza Midwood area)
                '28204': [35.2173, -80.8309], // Charlotte (Midtown)
                '28202': [35.2270, -80.8453], // Charlotte (Uptown)
                '78701': [30.2672, -97.7431], // Austin, TX
                '90210': [34.0736, -118.4004], // Beverly Hills, CA
                '10001': [40.7505, -73.9968], // NYC, NY
                '80202': [39.7392, -104.9903] // Denver, CO
            };
            return zipCoords[zip] || null; 
        }

        function addMarkers(shopList, userLat, userLng) {
            markers.clearLayers(); 

            const shopsWithDistance = shopList.map(shop => {
                let distance = Infinity; 

                if (userLat && userLng) {
                    const userPoint = L.latLng(userLat, userLng);
                    const shopPoint = L.latLng(shop.lat, shop.lng);
                    distance = userPoint.distanceTo(shopPoint); 
                }
                
                return { ...shop, distance: distance };
            });

            shopsWithDistance.sort((a, b) => {
                // Sort Priority: 1. Closest distance, 2. Alphabetical name
                if (a.distance !== b.distance) {
                    return a.distance - b.distance; 
                }
                return a.name.localeCompare(b.name);
            });

            shopsWithDistance.forEach(shop => {
                const distanceInMiles = shop.distance !== Infinity ? (shop.distance / 1609.34).toFixed(1) + ' mi' : 'N/A';
                
                const isAffiliate = shop.link.includes("?aff=cannagrok"); 
                
                // Iconos con mejor dise√±o (uso de CSS classes definidas arriba)
                const icon = isAffiliate 
                    ? L.divIcon({
                        className: 'affiliate-marker',
                        html: `<div>‚≠ê ${shop.type}</div>`, // Estrella dorada para afiliados
                        iconSize: [80, 20],
                        iconAnchor: [40, 10]
                      })
                    : L.divIcon({ 
                        className: 'regular-marker',
                        html: `<div>üåø ${shop.type}</div>`, // Hoja verde para no afiliados
                        iconSize: [80, 20],
                        iconAnchor: [40, 10]
                      });


                const marker = L.marker([shop.lat, shop.lng], { icon: icon });

                // Popup mejorado
                let popupContent = `
                    <div style="font-family: 'Inter', sans-serif;">
                        <h4 style="margin: 0 0 5px; color: ${isAffiliate ? 'var(--gold-accent)' : 'var(--green-dark)'}; border-bottom: 2px solid ${isAffiliate ? 'var(--gold-accent)' : 'var(--green-dark)'}; padding-bottom: 5px;">
                            ${isAffiliate ? '‚≠ê AFFILIATE DEAL' : 'DISPENSARY'} | ${shop.name}
                        </h4>
                        <p style="margin: 0 0 5px; font-size: 0.9em;">
                            <strong>Product:</strong> ${shop.type}<br>
                            <strong>Details:</strong> ${shop.note}<br>
                            ${shop.distance !== Infinity ? `<strong>Distance:</strong> ${distanceInMiles}<br>` : ''}
                        </p>
                        ${shop.link && shop.link !== '#'
                            ? `<a href="${shop.link}" target="_blank" class="popup-link" style="
                                background-color: ${isAffiliate ? 'var(--gold-accent)' : 'var(--green-light)'};
                                color: ${isAffiliate ? 'var(--gray-dark)' : 'white'};
                                border: ${isAffiliate ? '1px solid var(--gray-dark)' : 'none'};
                            ">VIEW STORE / CLAIM DEAL ‚Üí</a>`
                            : `<p style="margin-top:10px; font-size:0.8em; color:gray;">Link unavailable.</p>`
                        }
                    </div>
                `;

                marker.bindPopup(popupContent);
                markers.addLayer(marker);
            });

            // Update Local VIP Deals on Dashboard (if premium)
            const premiumStatus = localStorage.getItem('cannagrok_premium');
            const localDealsDiv = document.querySelector('#premiumDashboard .dashboard-section:nth-child(4)');

            if (premiumStatus === 'unlocked' && localDealsDiv) {
                // Logic to update local deals based on zip and distance (kept from previous version)
                const nearestAffiliates = shopsWithDistance.filter(s => s.link.includes("?aff=cannagrok") && s.distance !== Infinity).slice(0, 3);
                
                if (nearestAffiliates.length > 0) {
                    let dealsHtml = `<p style="font-size:0.9em; color:#444;">*Daily alerts on the best local discounts and offers from affiliates near your Zip Code (${localStorage.getItem('profileZip') || 'N/A'}).*</p><ul>`;
                    nearestAffiliates.forEach(shop => {
                        const distMi = (shop.distance / 1609.34).toFixed(1);
                        dealsHtml += `<li><strong>üî• VIP Deal:</strong> ${shop.name} (${distMi} mi) - <a href="${shop.link}" target="_blank" style="color:var(--green-dark); font-weight:700;">View Offer</a></li>`;
                    });
                    dealsHtml += `</ul>`;
                    localDealsDiv.innerHTML = `<h3>Local VIP Deals</h3>${dealsHtml}`;
                } else {
                     localDealsDiv.innerHTML = `<h3>Local VIP Deals</h3><p style="font-size:0.9em; color:#444;">No affiliates found near your Zip Code.</p>`;
                }
            }
        }

        // --- Keep centerOnState, filterMap, loadProfileData ---
        function centerOnState() {
            const stateCode = document.getElementById('stateSelect').value;
            const infoDiv = document.getElementById('stateInfo');
            
            if (stateCode) {
                const [lat, lng] = stateCenters[stateCode];
                map.setView([lat, lng], 10);
                infoDiv.textContent = `Displaying: ${document.querySelector('#stateSelect option:checked').text}`;
                filterMap(); 
            } else {
                map.setView([39.8283, -98.5795], 4);
                infoDiv.textContent = 'National View';
                filterMap(); 
            }
        }

        function filterMap() {
            const searchTerm = document.getElementById('search').value.toLowerCase();
            const selectedState = document.getElementById('stateSelect').value;
            
            const filteredShops = shops.filter(shop => {
                const stateMatch = !selectedState || shop.state === selectedState;
                const searchMatch = !searchTerm || 
                                    shop.name.toLowerCase().includes(searchTerm) ||
                                    shop.type.toLowerCase().includes(searchTerm) ||
                                    shop.note.toLowerCase().includes(searchTerm);
                return stateMatch && searchMatch;
            });

            addMarkers(filteredShops, currentZipLat, currentZipLng); 
        }

        function loadProfileData() {
            document.getElementById('profileGoal').value = localStorage.getItem('profileGoal') || 'sleep';
            document.getElementById('profileExperience').value = localStorage.getItem('profileExperience') || 'novice';
            
            const userZip = localStorage.getItem('profileZip');
            document.getElementById('profileZip').value = userZip || '';
            
            const coords = getZipCodeCoordinates(userZip);

            if (coords) {
                currentZipLat = coords[0];
                currentZipLng = coords[1];
            } else {
                // Default center if no zip or invalid zip is provided
                currentZipLat = 35.2271; 
                currentZipLng = -80.8431; 
            }

            filterMap();
        }


        window.onload = function() {
            checkDailyReset();
            updateQueryCounter();
            checkAccess(); 
            loadProfileData(); 
        }
        
    </script>
</body>
</html>
